<html>
<head>
    <title>WebSocket通讯</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Free Responsive Html5 Templates">
    <meta name="author" content="">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/index.css">
    <script type="text/javascript" src="/js/jquery-2.1.1.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        url = "ws://localhost:8381/message"; // 通讯地址
        window.onload = function () {	// 进行加载时间处理
            webSocket = new WebSocket(url); // 创建WebSocket对象
            webSocket.onopen = function () {
                //alert("服务器连接成功，请进行消息的处理。");
                // document.getElementById("contentDiv").innerHTML += "<p>服务器连接成功，请进行消息的处理。</p>";
            }
            webSocket.onclose = function () {
                alert("已经和服务器断开连接。");
                // document.getElementById("contentDiv").innerHTML += "<p>已经和服务器断开连接。</p>";
            }

            $("#msg").focus(function () {
                this.select();
            });

            webSocket.onmessage = function (obj) {	// 进行消息回应
                $("#msg").val("").focus();
                var str = "";
                if (obj.data == "ng") {
                    $.post("/sorting/ng", {ng: obj.data}, function (data) {
                        str = "<tr><td COLSPAN='10'>NG</td></tr><tr><td id=" + data.n_barcode + ">条形码:" + data.n_barcode + "</td><td>时间:" + data.n_date + "</td><td>数量:" + data.n_number + "</td></tr>";
                        $("#tbody_ng").html(str);
                    }, "json")
                } else {
                    $.post("/sorting/data", {order: obj.data}, function (data) {
                        //订单号
                        var c_order = $("#" + data.c_order).text();
                        var count = data.c_count;
                        var number = data.c_number;
                        if (count <= number) {
                            $("#" + obj.data).parent().css("background-color", "#faf24a");
                        }
                        if (count == 1) {
                            var css = ("background-color:#faf24a");
                        }
                        //alert("获取到的订单号:"+c_order);
                        //alert("传值的订单号:"+order);
                        if (Number(c_order) == Number(obj.data)) {
                            // alert("已有这行数据");
                            str = "<td id=" + data.c_order + "> " + data.c_order + "</td><td id=" + data.c_barcode + ">" + data.c_barcode + "</td><td>" + data.c_out + "</td><td>" + data.c_count + "</td><td>" + data.c_specification + "</td><td>" + data.c_describe + "</td><td class='text-align:center;'>" + data.c_current + "</td><td>" + data.c_customername + "</td><td>" + data.c_number + "</td>";
                            $("#" + obj.data).parent().html(str);
                        } else {
                            str += "<tr style='" + css + ";text-align: center'><td id=" + data.c_order + ">" + data.c_order + "</td><td id=" + data.c_barcode + ">" + data.c_barcode + "</td><td>" + data.c_out + "</td><td>" + data.c_count + "</td><td>" + data.c_specification + "</td><td>" + data.c_describe + "</td><td class='text-align:center;'>" + data.c_current + "</td><td>" + data.c_customername + "</td><td>" + data.c_number + "</td></tr>";
                            $("#tbody").append(str);
                        }
                    }, "json")
                }

            }


            document.getElementById("sendBut").addEventListener("click", function () {
                info = document.getElementById("msg").value;
                var barcode = $("#msg").val();
                webSocket.send(barcode); // 发送请求
                /* webSocket.onmessage = function(obj) {	// 进行消息回应
                     alert("obj.data2"+obj.data );
                     document.getElementById("contentDiv").innerHTML += "<span>" + obj.data + "</span>" ;
                     document.getElementById("msg").value = "" ;
                 }*/
            }, false);


            var code = "";
            var lastTime, nextTime;
            var lastCode, nextCode;

            document.onkeypress = function (e) {
                nextCode = e.which;
                nextTime = new Date().getTime();

                if (lastCode != null && lastTime != null && nextTime - lastTime <= 30) {
                    code += String.fromCharCode(lastCode);
                } else if (lastCode != null && lastTime != null && nextTime - lastTime > 100) {
                    code = "";
                }

                lastCode = nextCode;
                lastTime = nextTime;
            }

            this.onkeypress = function (e) {
                if (e.which == 13) {
                    webSocket.send(code); // 发送请求
                    console.log(code);
                    code = "";
                }
            }
        }
    </script>
    <style>
        @keyframes spread {
            0% {
                width: 0px;
            }
            10% {
                width: 10px;
            }
            20% {
                width: 20px;
            }
            30% {
                width: 30px;
            }
            40% {
                width: 40px;
            }
            50% {
                width: 50px;
            }
            60% {
                width: 60px;
            }
            70% {
                width: 70px;
            }
            80% {
                width: 80px;
            }
            90% {
                width: 90px;
            }
            100% {
                width: 100px;
            }
        }

        .rotate {
            transition: all 1s;
        }

        .rotate:active {
            transform: rotate(360deg) scale(1);
        }
    </style>
</head>
<body ondragstart="window.event.returnValue=false" oncontextmenu="window.event.returnValue=false"
      onselectstart="event.returnValue=false">
<!--<div id="inputDiv" style="text-align: center">
    请输入信息：<input type="text" name="msg" id="msg">
    <button type="button" id="sendBut">发送</button>
</div>-->
<!--按纽作为addon-->
<div class="input-group" style="width: 20%;text-align: center;margin:20px auto">
    <input type="text" name="msg" id="msg" class="form-control" placeholder="请输入条形码信息">
    <span class="input-group-btn ">
				<button class="btn btn-primary" type="button" id="sendBut">查询</button>
    </span>
</div>
<div class="body-section">
    <section class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <table class="table text-center table-hover data">
                <thead>
                <tr>
                    <th>订单号</th>
                    <th>条码</th>
                    <th>OUT</th>
                    <th>数量</th>
                    <th class="">规格</th>
                    <th>描述</th>
                    <th style="text-align:center">日期</th>
                    <th>客户名称</th>
                    <th>已分拣数量</th>
                </tr>
                <tbody id="tbody">

                </tbody>
                <tbody id="tbody_ng" style="margin-top: 400px;position: absolute;">

                </tbody>
                </thead>

            </table>

        </div>
        <div class="col-md-2"></div>
    </section>
</div>
<span></span>
　<!--<input type="barcode" name="barcode"  />-->
</body>
</html>